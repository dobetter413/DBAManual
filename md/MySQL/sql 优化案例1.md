# SQL 优化案例1
## 一、问题现象
### 1、如下sql 语句执行时间超过5min，效率太差无法满足生产需求
```
SELECT E.CAMPSEG_PID CAMPSEG_PID,GROUP_CONCAT(DISTINCT C.CEP_EVENT_ID) CEP_EVENT_ID,GROUP_CONCAT(DISTINCT C.CHANNEL_ID) CHANNEL_ID,  GROUP_CONCAT(DISTINCT C.CHANNEL_NAME) CHANNEL_NAME,GROUP_CONCAT(DISTINCT EXTBJ.E_901_TEST_SMS_STATUS) E_901_TEST_SMS_STATUS,  GROUP_CONCAT(DISTINCT EXTBJ.E_937_TEST_SMS_STATUS) E_937_TEST_SMS_STATUS 
FROM MCD_CAMP_DEF E  
LEFT JOIN 
    (SELECT A.CAMPSEG_ID   CAMPSEG_ID,A.CEP_EVENT_ID CEP_EVENT_ID,B.CHANNEL_ID CHANNEL_ID,B.CHANNEL_NAME CHANNEL_NAME  
        FROM MCD_CAMP_CHANNEL_LIST A LEFT JOIN (SELECT CHANNEL_NAME ,CHANNEL_ID  FROM MCD_DIM_CHANNEL) B ON A.CHANNEL_ID = B.CHANNEL_ID ) C 
ON E.CAMPSEG_ID = C.CAMPSEG_ID  
LEFT JOIN 
    (SELECT E_901_TEST_SMS_STATUS ,E_937_TEST_SMS_STATUS,CAMPSEG_ID CAMPSEG_ID  FROM MCD_CAMP_CHANNEL_EXT_BJ WHERE CHANNEL_ID in ('901','9001','937') ) EXTBJ 
ON E.CAMPSEG_ID = EXTBJ.CAMPSEG_ID  WHERE 1 = 1  GROUP BY E.CAMPSEG_PID;
```

## 二、问题分析
### 1、通过dbscale show table location table_name; 分析表分布位置，定位到此SQL 语句涉及到的表位于同一数据源 global_ds
>那么后续的问题就涉及单机sql 语句的优化

### 2、查看执行计划
```
greatdb> explain SELECT E.CAMPSEG_PID CAMPSEG_PID,GROUP_CONCAT(DISTINCT C.CEP_EVENT_ID) CEP_EVENT_ID,GROUP_CONCAT(DISTINCT C.CHANNEL_ID) CHANNEL_ID,  GROUP_CONCAT(DISTINCT C.CHANNEL_NAME) CHANNEL_NAME,GROUP_CONCAT(DISTINCT EXTBJ.E_901_TEST_SMS_STATUS) E_901_TEST_SMS_STATUS,  GROUP_CONCAT(DISTINCT EXTBJ.E_937_TEST_SMS_STATUS) E_937_TEST_SMS_STATUS 
    -> FROM MCD_CAMP_DEF E  
    -> LEFT JOIN 
    ->     (SELECT A.CAMPSEG_ID   CAMPSEG_ID,A.CEP_EVENT_ID CEP_EVENT_ID,B.CHANNEL_ID CHANNEL_ID,B.CHANNEL_NAME CHANNEL_NAME  
    ->         FROM MCD_CAMP_CHANNEL_LIST A LEFT JOIN (SELECT CHANNEL_NAME ,CHANNEL_ID  FROM MCD_DIM_CHANNEL) B ON A.CHANNEL_ID = B.CHANNEL_ID ) C 
    -> ON E.CAMPSEG_ID = C.CAMPSEG_ID  
    -> LEFT JOIN 
    ->     (SELECT E_901_TEST_SMS_STATUS ,E_937_TEST_SMS_STATUS,CAMPSEG_ID CAMPSEG_ID  FROM MCD_CAMP_CHANNEL_EXT_BJ WHERE CHANNEL_ID in ('901','9001','937') ) EXTBJ 
    -> ON E.CAMPSEG_ID = EXTBJ.CAMPSEG_ID  WHERE 1 = 1  GROUP BY E.CAMPSEG_PID;
+----+-------------+-------------------------+------------+------+---------------+------+---------+------+-------+----------+----------------------------------------------------+
| id | select_type | table                   | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                                              |
+----+-------------+-------------------------+------------+------+---------------+------+---------+------+-------+----------+----------------------------------------------------+
|  1 | SIMPLE      | E                       | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 32867 |   100.00 | Using temporary; Using filesort                    |
|  1 | SIMPLE      | A                       | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20424 |   100.00 | Using where; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | MCD_DIM_CHANNEL         | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    30 |   100.00 | Using where; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | MCD_CAMP_CHANNEL_EXT_BJ | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 17374 |   100.00 | Using where; Using join buffer (Block Nested Loop) |
+----+-------------+-------------------------+------------+------+---------------+------+---------+------+-------+----------+----------------------------------------------------+
4 rows in set, 1 warning (0.00 sec)
```

### 3、查看表结构
```
greatdb> show create table mcd_dim_channel;
+-----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table           | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+-----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mcd_dim_channel | CREATE TABLE `mcd_dim_channel` (
  `CHANNEL_ID` varchar(20) NOT NULL,
  `CHANNELTYPE_ID` bigint(22) DEFAULT NULL,
  `CHANNEL_NAME` varchar(50) NOT NULL,
  `PARENT_ID` varchar(20) DEFAULT NULL,
  `CREATE_USER` varchar(30) DEFAULT NULL,
  `EXEC_CONTENT_FLAG` bigint(22) DEFAULT NULL,
  `ORDER_NUM` bigint(22) DEFAULT NULL,
  `CHANNEL_CLASS` bigint(22) DEFAULT NULL,
  `DISPLAY_ORDER` int(10) DEFAULT NULL,
  `CHANNEL_CODE` varchar(20) DEFAULT NULL,
  `ONLINE_STATUS` bigint(22) DEFAULT NULL,
  `TOUCH_TYPE` varchar(1) NOT NULL,
  `IOP_PREFIX_CODE` varchar(30) DEFAULT NULL,
  `IOP_CHANNEL_TYPE` varchar(20) DEFAULT NULL,
  `DESCRIPTION` varchar(1024) DEFAULT NULL,
  `OPERATOR` varchar(32) DEFAULT NULL,
  `IS_FRONTLINE` varchar(2) DEFAULT NULL,
  `CREATE_TIME` datetime DEFAULT NULL,
  `IOP_CHANNEL_NAME` varchar(50) DEFAULT NULL,
  `CHANNEL_TYPE` bigint(22) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT |
+-----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

greatdb> show create table mcd_camp_channel_list;
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table                 | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mcd_camp_channel_list | CREATE TABLE `mcd_camp_channel_list` (
  `CAMPSEG_ID` varchar(32) NOT NULL,
  `CONTACT_TYPE` bigint(22) DEFAULT NULL,
  `CHANNEL_ID` text NOT NULL,
  `TARGER_USER_NUMS` bigint(22) DEFAULT NULL,
  `IF_HAVE_VAR` bigint(22) DEFAULT NULL,
  `EXEC_CONTENT` text,
  `UPDATE_CYCLE` bigint(22) DEFAULT NULL,
  `CHANNEL_ADIV_ID` varchar(1000) NOT NULL,
  `APPROVE_RESULT` bigint(22) DEFAULT NULL,
  `APPROVE_RESULT_DESC` text,
  `CHANNEL_ADIVD_ID` varchar(1000) DEFAULT NULL,
  `PARAM_DAYS` bigint(22) DEFAULT NULL,
  `PARAM_NUM` bigint(22) DEFAULT NULL,
  `AWARD_MOUNT` bigint(22) DEFAULT NULL,
  `EDIT_URL` text,
  `HANDLE_URL` text,
  `SEND_SMS` varchar(512) DEFAULT NULL,
  `BOSS_SMS_TEMPLATE_ID` varchar(32) DEFAULT NULL,
  `EXEC_TITLE` varchar(128) DEFAULT NULL,
  `FILE_NAME` varchar(128) DEFAULT NULL,
  `FILE_REMOTE_NAME` varchar(300) DEFAULT NULL,
  `CALL_QUEUE` bigint(22) DEFAULT NULL,
  `EVENT_INSTANCE_DESC` varchar(1000) DEFAULT NULL,
  `EVENT_PARAM_JSON` text,
  `EVENT_ACTIVE_TEMPLET_ID` varchar(32) DEFAULT NULL,
  `FUNCTION_ID` varchar(32) DEFAULT NULL,
  `APPOINTMENT_TIME` bigint(22) DEFAULT NULL,
  `ONE_WORDS_CONTENT` text,
  `BOOTH_ID` varchar(5) DEFAULT NULL,
  `CEP_EVENT_ID` varchar(32) DEFAULT NULL,
  `CEP_SCENE_NAME` varchar(200) DEFAULT NULL,
  `CHANNEL_ADIVD_NAME` varchar(1000) DEFAULT NULL,
  `PCC_ID` varchar(64) DEFAULT NULL,
  `CHANNEL_ADIV_NAME` text,
  `BOTHER_AVOID_CUSTOMER_TYPE` varchar(1024) DEFAULT NULL,
  `BOTHER_AVOID_CUSTOMER_NAME` varchar(1024) DEFAULT NULL,
  `IS_MULTI_ADIV` tinyint(1) DEFAULT NULL,
  `IS_MULTI_MATERIAL` tinyint(1) DEFAULT NULL,
  `STREAM_EVENT_ID` varchar(32) DEFAULT NULL,
  `TARGET_CUSTOMER_ATTR_TYPE` tinyint(2) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
greatdb> show create table mcd_camp_channel_ext_bj;
+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table                   | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mcd_camp_channel_ext_bj | CREATE TABLE `mcd_camp_channel_ext_bj` (
  `CAMPSEG_ID` varchar(32) NOT NULL,
  `CHANNEL_ID` varchar(32) NOT NULL,
  `E_914_COVER_AREA_ID` text,
  `E_914_COVER_AREA_NAME` text,
  `E_914_RISK_WARN_STATEMENT` varchar(500) DEFAULT NULL,
  `E_901_TEST_PHONES` varchar(550) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
greatdb> show create table mcd_camp_channel_list;
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table                 | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mcd_camp_channel_list | CREATE TABLE `mcd_camp_channel_list` (
  `CAMPSEG_ID` varchar(32) NOT NULL,
  `CONTACT_TYPE` bigint(22) DEFAULT NULL,
  `CHANNEL_ID` text NOT NULL,
  `TARGER_USER_NUMS` bigint(22) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
greatdb> show create table mcd_camp_def;
+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table        | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mcd_camp_def | CREATE TABLE `mcd_camp_def` (
  `CAMPSEG_ID` varchar(32) NOT NULL,
  `CAMPSEG_NAME` varchar(300) DEFAULT NULL,
  `START_DATE` varchar(32) DEFAULT NULL,
  `END_DATE` varchar(32) DEFAULT NULL,
  `CAMPSEG_STAT_ID` bigint(22) DEFAULT NULL,
  `CAMPSEG_TYPE_ID` bigint(22) DEFAULT NULL,
  `CAMP_PRI_ID` bigint(22) DEFAULT NULL,
  `APPROVE_FLOW_ID` varchar(32) DEFAULT NULL,
  `CREATE_USERID` varchar(20) DEFAULT NULL,
  `CITY_ID` varchar(25) DEFAULT NULL,
  `DEPTID` bigint(22) DEFAULT NULL,
  `CREATE_TIME` datetime NOT NULL,
  `TARGER_USER_NUMS` bigint(22) DEFAULT NULL,
  `CAMPSEG_PID` varchar(32) DEFAULT NULL,
  `CAMP_CLASS` bigint(22) DEFAULT NULL,
  `PLAN_ID` varchar(18) DEFAULT NULL
  PRIMARY KEY (`CAMPSEG_ID`),
  KEY `ix_planid` (`PLAN_ID`),
  KEY `ix_cityid` (`CITY_ID`),
  KEY `index_mcd_camp_def` (`CAMPSEG_ID`,`DEPTID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT |
+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```
> 备注: 表结构中的列太长有简化

### 4、分析执行计划
4.1发现该SQL 语句的执行计划各个阶段均无法利用索引，且存在多次join 连接，执行计划较差
4.2查看表结构发现连接列和分组相关的列大多没有合理的索引
4.3group by 分组排序为利用索引，反而使用临时表和文件排序

### 5、创建合适的列创建索引
```
 create index ix_cid on mcd_dim_channel(CHANNEL_ID);
 create index ix_caid on mcd_camp_channel_list(CAMPSEG_ID);
 create index ix_cid on mcd_camp_channel_ext_bj(CHANNEL_ID);
 create index ix_chaid on mcd_camp_channel_list(CHANNEL_ID(30));
 create index ix_caid on mcd_camp_channel_ext_bj(CAMPSEG_ID); 
 create index ix_campid on mcd_camp_def(CAMPSEG_PID);
```

### 6、再次分析执行计划
```
greatdb> explain SELECT E.CAMPSEG_PID CAMPSEG_PID,GROUP_CONCAT(DISTINCT C.CEP_EVENT_ID) CEP_EVENT_ID,GROUP_CONCAT(DISTINCT C.CHANNEL_ID) CHANNEL_ID,  GROUP_CONCAT(DISTINCT C.CHANNEL_NAME) CHANNEL_NAME,GROUP_CONCAT(DISTINCT EXTBJ.E_901_TEST_SMS_STATUS) E_901_TEST_SMS_STATUS,  GROUP_CONCAT(DISTINCT EXTBJ.E_937_TEST_SMS_STATUS) E_937_TEST_SMS_STATUS  FROM MCD_CAMP_DEF E   LEFT JOIN      (SELECT A.CAMPSEG_ID   CAMPSEG_ID,A.CEP_EVENT_ID CEP_EVENT_ID,B.CHANNEL_ID CHANNEL_ID,B.CHANNEL_NAME CHANNEL_NAME           FROM MCD_CAMP_CHANNEL_LIST A LEFT JOIN (SELECT CHANNEL_NAME ,CHANNEL_ID  FROM MCD_DIM_CHANNEL) B ON A.CHANNEL_ID = B.CHANNEL_ID ) C  ON E.CAMPSEG_ID = C.CAMPSEG_ID   LEFT JOIN      (SELECT E_901_TEST_SMS_STATUS ,E_937_TEST_SMS_STATUS,CAMPSEG_ID CAMPSEG_ID  FROM MCD_CAMP_CHANNEL_EXT_BJ WHERE CHANNEL_ID in ('901','9001','937') ) EXTBJ  ON E.CAMPSEG_ID = EXTBJ.CAMPSEG_ID  WHERE 1 = 1  GROUP BY E.CAMPSEG_PID;
+----+-------------+-------------------------+------------+-------+----------------+-----------+---------+-----------------------+-------+----------+-------------+
| id | select_type | table                   | partitions | type  | possible_keys  | key       | key_len | ref                   | rows  | filtered | Extra       |
+----+-------------+-------------------------+------------+-------+----------------+-----------+---------+-----------------------+-------+----------+-------------+
|  1 | SIMPLE      | E                       | NULL       | index | ix_campid      | ix_campid | 99      | NULL                  | 32867 |   100.00 | Using index |
|  1 | SIMPLE      | A                       | NULL       | ref   | ix_caid        | ix_caid   | 98      | mcd_core.E.CAMPSEG_ID |     1 |   100.00 | NULL        |
|  1 | SIMPLE      | MCD_DIM_CHANNEL         | NULL       | ref   | ix_cid         | ix_cid    | 62      | mcd_core.A.CHANNEL_ID |     1 |   100.00 | Using where |
|  1 | SIMPLE      | MCD_CAMP_CHANNEL_EXT_BJ | NULL       | ref   | ix_cid,ix_caid | ix_caid   | 98      | mcd_core.E.CAMPSEG_ID |     1 |   100.00 | Using where |
+----+-------------+-------------------------+------------+-------+----------------+-----------+---------+-----------------------+-------+----------+-------------+
4 rows in set, 1 warning (0.00 sec)

greatdb> 
```

6.1、发现索引优化后执行计划各个阶段均可使用索引，扫描行数大幅下降
6.2、实际执行SQL发现执行时间缩短至0.5s





