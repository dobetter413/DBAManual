mysql  lock 
# RC
## 主键表
```
mysql> show create table t_primary;
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table     | Create Table                                                                                                                                                                                                                   |
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t_primary | CREATE TABLE `t_primary` (
  `id` int NOT NULL,
  `name` varchar(10) DEFAULT NULL,
  `pid` int DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `ix_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> select * from t_primary;
+----+------+------+
| id | name | pid  |
+----+------+------+
|  1 | a    |  101 |
|  2 | b    |  102 |
|  3 | c    |  103 |
|  4 | d    |  104 |
|  5 | e    |  105 |
|  6 | f    |  106 |
+----+------+------+
6 rows in set (0.40 sec)

```
### where 主键
```
update t_primary set pid=1006 where id=6;
```
+ show engine innodb status
```
---TRANSACTION 212485601, ACTIVE 4 sec
2 lock struct(s), heap size 1128, 1 row lock(s), undo log entries 1
MySQL thread id 33, OS thread handle 140667820959488, query id 332 127.0.0.1 root
```
+ data_locks
```
mysql> select * from data_locks;
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                            | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762904:96127:140668651823648     |             212485601 |        98 |       15 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651823648 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762904:94916:4:7:140668651530272 |             212485601 |        98 |       15 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651530272 | RECORD    | X,REC_NOT_GAP | GRANTED     | 6         |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
2 rows in set (0.01 sec)
```
+ innodb_trx
```
mysql> select * from INNODB_TRX;
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| trx_id    | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout | trx_is_read_only | trx_autocommit_non_locking | trx_schedule_weight |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| 212485601 | RUNNING   | 2023-06-19 17:02:48 | NULL                  | NULL             |          3 |                  33 | NULL      | NULL                |                 0 |                 1 |                2 |                  1128 |               1 |                 1 |                       0 | READ COMMITTED      |                 1 |                      1 | NULL                       |                         0 |                         0 |                0 |                          0 |                NULL |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
1 row in set (0.00 sec)
```
### where key
```
update t_primary set pid=106 where name='f';
```
+ show engine innodb status
```
---TRANSACTION 212485614, ACTIVE 173 sec
3 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
MySQL thread id 33, OS thread handle 140667820959488, query id 364 127.0.0.1 root
```
+ data_locks
```
mysql> select * from data_locks;
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                            | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762904:96127:140668651823648     |             212485614 |        98 |       26 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651823648 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762904:94916:5:7:140668651530272 |             212485614 |        98 |       26 | cm            | t_primary   | NULL           | NULL              | ix_name    |       140668651530272 | RECORD    | X,REC_NOT_GAP | GRANTED     | 'f', 6    |
| INNODB | 140668636762904:94916:4:7:140668651530616 |             212485614 |        98 |       26 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651530616 | RECORD    | X,REC_NOT_GAP | GRANTED     | 6         |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
3 rows in set (0.00 sec)

```
+ innodb_trx
```
mysql> select * from information_schema.innodb_trx;
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| trx_id    | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout | trx_is_read_only | trx_autocommit_non_locking | trx_schedule_weight |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| 212485614 | RUNNING   | 2023-06-19 17:25:44 | NULL                  | NULL             |          4 |                  33 | NULL      | NULL                |                 0 |                 1 |                3 |                  1128 |               2 |                 1 |                       0 | READ COMMITTED      |                 1 |                      1 | NULL                       |                         0 |                         0 |                0 |                          0 |                NULL |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
1 row in set (0.00 sec)
```


### where 无索引列
```
update t_primary set pid=1006 where pid=1006;
```
+ show engine innodb status
```
---TRANSACTION 212485620, ACTIVE 15 sec
2 lock struct(s), heap size 1128, 1 row lock(s)
MySQL thread id 33, OS thread handle 140667820959488, query id 389 127.0.0.1 root
```
+ data_locks
```
mysql> select * from data_locks;
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                            | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762904:96127:140668651823648     |             212485620 |        98 |       44 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651823648 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762904:94916:4:7:140668651530272 |             212485620 |        98 |       44 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651530272 | RECORD    | X,REC_NOT_GAP | GRANTED     | 6         |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
2 rows in set (0.00 sec)
```
+ innodb_trx
#### 更新非索引列
```
mysql> select * from t_primary;
+----+------+------+
| id | name | pid  |
+----+------+------+
|  1 | a    |  101 |
|  2 | b    |  102 |
|  3 | c    |  103 |
|  4 | d    |  104 |
|  5 | e    | 1005 |
|  6 | f    | 1006 |
|  7 | g    | 1006 |
+----+------+------+
7 rows in set (0.01 sec)
update t_primary set pid=105 where pid=1005;
```

+ show engine innodb status\G
```
---TRANSACTION 212647062, ACTIVE 469 sec
2 lock struct(s), heap size 1128, 1 row lock(s), undo log entries 1
MySQL thread id 37, OS thread handle 140667634317056, query id 472 127.0.0.1 root
```
+ data_locks
```
mysql> select * from performance_schema.data_locks;
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                            | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762096:96127:140668651822880     |             212647062 |       109 |        8 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651822880 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762096:94916:4:6:140668651527200 |             212647062 |       109 |        8 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651527200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
+--------+-------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
2 rows in set (0.00 sec)
```
+ innodb_trx
```
mysql> select * from information_schema.innodb_trx;
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| trx_id    | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout | trx_is_read_only | trx_autocommit_non_locking | trx_schedule_weight |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| 212647062 | RUNNING   | 2023-06-20 10:06:04 | NULL                  | NULL             |          3 |                  37 | NULL      | NULL                |                 0 |                 1 |                2 |                  1128 |               1 |                 1 |                       0 | READ COMMITTED      |                 1 |                      1 | NULL                       |                         0 |                         0 |                0 |                          0 |                NULL |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
1 row in set (0.01 sec)
```

  
#### 更新索引列
```
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t_primary;
+----+------+------+
| id | name | pid  |
+----+------+------+
|  1 | a    |  101 |
|  2 | b    |  102 |
|  3 | c    |  103 |
|  4 | d    |  104 |
|  5 | e    |  105 |
|  6 | f    | 1006 |
|  7 | g    | 1006 |
+----+------+------+
7 rows in set (0.00 sec)

mysql> update t_primary set name='ee' where pid=105;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

```
+ show engine innodb status
```
---TRANSACTION 212647065, ACTIVE 58 sec
2 lock struct(s), heap size 1128, 1 row lock(s), undo log entries 1
MySQL thread id 37, OS thread handle 140667634317056, query id 480 127.0.0.1 root
```
+ data_locks
```
mysql> select * from performance_schema.data_locks;
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762096:96127:140668651822880      |             212647065 |       109 |       14 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651822880 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762096:94916:4:10:140668651527200 |             212647065 |       109 |       14 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651527200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
2 rows in set (0.01 sec)

```
+ innodb_trx
```
mysql> select * from information_schema.innodb_trx;
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| trx_id    | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout | trx_is_read_only | trx_autocommit_non_locking | trx_schedule_weight |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| 212647065 | RUNNING   | 2023-06-20 10:27:32 | NULL                  | NULL             |          3 |                  37 | NULL      | NULL                |                 0 |                 1 |                2 |                  1128 |               1 |                 1 |                       0 | READ COMMITTED      |                 1 |                      1 | NULL                       |                         0 |                         0 |                0 |                          0 |                NULL |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
1 row in set (0.00 sec)

```

#### 更新主键列
```
mysql> begin;
Query OK, 0 rows affected (0.01 sec)

mysql> select * from t_primary;
+----+------+------+
| id | name | pid  |
+----+------+------+
|  1 | a    |  101 |
|  2 | b    |  102 |
|  3 | c    |  103 |
|  4 | d    |  104 |
|  5 | ee   |  105 |
|  6 | f    | 1006 |
|  7 | g    | 1006 |
+----+------+------+
7 rows in set (0.00 sec)

mysql> update t_primary set id=55 where pid=105;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> 
```

+ show engine innodb status
```
---TRANSACTION 212647076, ACTIVE 253 sec
2 lock struct(s), heap size 1128, 1 row lock(s), undo log entries 2
MySQL thread id 37, OS thread handle 140667634317056, query id 498 127.0.0.1 root
```
+ data_locks
```
mysql> select * from performance_schema.data_locks;
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                             | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140668636762096:96127:140668651822880      |             212647076 |       109 |       30 | cm            | t_primary   | NULL           | NULL              | NULL       |       140668651822880 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140668636762096:94916:4:10:140668651527200 |             212647076 |       109 |       30 | cm            | t_primary   | NULL           | NULL              | PRIMARY    |       140668651527200 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
+--------+--------------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
2 rows in set (0.01 sec)

```
+ innodb_trx
```
mysql> select * from information_schema.innodb_trx;
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| trx_id    | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout | trx_is_read_only | trx_autocommit_non_locking | trx_schedule_weight |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
| 212647076 | RUNNING   | 2023-06-20 10:43:17 | NULL                  | NULL             |          4 |                  37 | NULL      | NULL                |                 0 |                 1 |                2 |                  1128 |               1 |                 2 |                       0 | READ COMMITTED      |                 1 |                      1 | NULL                       |                         0 |                         0 |                0 |                          0 |                NULL |
+-----------+-----------+---------------------+-----------------------+------------------+------------+---------------------+-----------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+------------------+----------------------------+---------------------+
1 row in set (0.00 sec)
```
此时行锁在主键列 5上,但55上也有锁,只是没有显示.如果这是插入或更新55 也会出现行锁阻塞

